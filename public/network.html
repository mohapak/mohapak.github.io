<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Board Network Visualization - Thesis Defense</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden; /* allow vertical scroll, hide horizontal */
      overflow-y: auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #1e293b;
      margin: 0;
    }

    .header p {
      font-size: 0.9rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .container {
      flex: 1;
      display: flex;
      padding: 1.5rem;
      gap: 1.5rem;
      overflow: hidden;
    }

    .main-content {
      flex: 1;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .controls {
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid #0ea5e9;
      border-radius: 8px;
      font-weight: 500;
    }

    .year-selector label {
      font-size: 0.875rem;
      color: #0f172a;
      font-weight: 600;
    }

    .year-selector select {
      padding: 0.375rem 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      background: white;
      color: #0f172a;
      font-weight: 500;
      outline: none;
      transition: all 0.2s;
    }

    .year-selector select:hover {
      border-color: #0ea5e9;
    }

    .year-selector select:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    button {
      padding: 0.5rem 1rem;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    button:hover {
      background: #0284c7;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    .legend {
      display: flex;
      gap: 1rem;
      margin-left: auto;
      align-items: center;
      font-size: 0.75rem;
      color: #64748b;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .legend-circle {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    #network {
      flex: 1;
      width: 100%;
      cursor: grab;
    }

    #network:active {
      cursor: grabbing;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      overflow-y: auto;
    }

    .sidebar h3 {
      font-size: 1.125rem;
      color: #1e293b;
      margin-bottom: 1rem;
    }

    .stat-card {
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #0ea5e9;
    }

    .info-text {
      font-size: 0.875rem;
      color: #64748b;
      line-height: 1.6;
    }

    .tooltip {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      background: rgba(15, 23, 42, 0.95);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -100%);
      margin-top: -12px;
      transition: opacity 0.2s;
      max-width: 250px;
      z-index: 1000;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top-color: #0ea5e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.125rem;
      color: #64748b;
    }

    .year-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(14, 165, 233, 0.9);
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
      z-index: 10;
    }

    @media (max-width: 1024px) {
      .sidebar {
        display: none;
      }
      
      .container {
        padding: 1rem;
      }

      .legend {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>The Effect of Board of Directors Network on Firm Performance</h1>
    <p>Tehran Stock Exchange - Interactive Network Visualization | Mohammad Mehdi Pakravan</p>
  </div>

  <div class="container">
    <div class="main-content">
      <div class="controls">
        <div class="year-selector">
          <label for="yearSelect">üìÖ Year:</label>
          <select id="yearSelect">
            <option value="2016">2016 (1395)</option>
            <option value="2017">2017 (1396)</option>
            <option value="2018">2018 (1397)</option>
            <option value="2019">2019 (1398)</option>
            <option value="2020">2020 (1399)</option>
            <option value="2021">2021 (1400)</option>
            <option value="2022">2022 (1401)</option>
            <option value="2023">2023 (1402)</option>
            <option value="2024" selected>2024 (1403)</option>
          </select>
        </div>
        
        <button id="resetBtn">Reset View</button>
        <button id="centerBtn">Center Network</button>
        <button id="pauseBtn">Pause Simulation</button>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-circle" style="background: #0ea5e9;"></div>
            <span>Highly Connected</span>
          </div>
          <div class="legend-item">
            <div class="legend-circle" style="background: #7dd3fc;"></div>
            <span>Moderately Connected</span>
          </div>
        </div>
      </div>
      
      <div class="year-badge" id="yearBadge">2024</div>
      <svg id="network"></svg>
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading network data...</div>
      </div>
    </div>

    <div class="sidebar">
      <h3>Network Statistics</h3>
      
      <div class="stat-card">
        <div class="stat-label">Total Firms</div>
        <div class="stat-value" id="totalNodes">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Board Interlocks</div>
        <div class="stat-value" id="totalLinks">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Average Connections</div>
        <div class="stat-value" id="avgDegree">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Network Density</div>
        <div class="stat-value" id="density">0%</div>
      </div>

      <h3 style="margin-top: 2rem;">How to Interact</h3>
      <div class="info-text">
        <p style="margin-bottom: 0.75rem;"><strong>üìÖ Select Year</strong> to view different periods</p>
        <p style="margin-bottom: 0.75rem;"><strong>üñ±Ô∏è Drag</strong> nodes to reposition them</p>
        <p style="margin-bottom: 0.75rem;"><strong>üîç Scroll</strong> to zoom in and out</p>
        <p style="margin-bottom: 0.75rem;"><strong>üëÜ Hover</strong> over nodes for details</p>
        <p><strong>üéØ Click</strong> Reset to restore view</p>
      </div>

      <h3 style="margin-top: 2rem;">Metrics</h3>
      <div class="info-text">
        <p style="margin-bottom: 0.75rem;">‚Ä¢ <strong>Node size:</strong> Number of board connections</p>
        <p style="margin-bottom: 0.75rem;">‚Ä¢ <strong>Link thickness:</strong> Shared directors</p>
        <p>‚Ä¢ <strong>Colors:</strong> Firms Sector</p>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentYear = '2024';
    let simulation;
    let transform = d3.zoomIdentity;
    let svg, g, zoom;
    let resizeHandler = null;
    
    // Elements
    const yearSelect = document.getElementById('yearSelect');
    const yearBadge = document.getElementById('yearBadge');
    const loading = d3.select('.loading');
    const tooltip = d3.select('body').append('div').attr('class', 'tooltip');
    
    // Initialize
    svg = d3.select('#network');
    
    // Year change handler
    yearSelect.addEventListener('change', (e) => {
      currentYear = e.target.value;
      loadYear(currentYear);
    });
    
    // Load initial year
    loadYear(currentYear);
    
    function loadYear(year) {
      // Show loading
      loading.style('display', 'block');
      loading.select('.loading-text').text('Loading network data...');
      loading.select('.loading-spinner').style('display', 'block');
      yearBadge.textContent = year;
      
      // Disable controls
      document.getElementById('resetBtn').disabled = true;
      document.getElementById('centerBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = true;
      
      // Clear previous network
      if (simulation) {
        simulation.stop();
      }
      svg.selectAll('*').remove();
      
      // Load data
      const dataUrl = `/data/board_network_${year}_no_isolates.json`; // adjust if needed
    
      d3.json(dataUrl)
        .then(data => {
          loading.style('display', 'none');
          // Update stats
          const nodes = data.nodes.length;
          const links = data.links.length;
          const avgDegree = (links * 2 / nodes).toFixed(1);
          const maxPossibleLinks = (nodes * (nodes - 1)) / 2;
          const density = ((links / maxPossibleLinks) * 100).toFixed(2);
          
          document.getElementById('totalNodes').textContent = nodes;
          document.getElementById('totalLinks').textContent = links;
          document.getElementById('avgDegree').textContent = avgDegree;
          document.getElementById('density').textContent = density + '%';
          
          // Enable controls
          document.getElementById('resetBtn').disabled = false;
          document.getElementById('centerBtn').disabled = false;
          document.getElementById('pauseBtn').disabled = false;
          document.getElementById('pauseBtn').textContent = 'Pause Simulation';
          
          renderNetwork(data);
        })
        .catch(err => {
          loading.select('.loading-text').text(`Failed to load data for ${year}. File may not exist.`);
          loading.select('.loading-spinner').style('display', 'none');
          console.error(err);
        });
    }

    function renderNetwork(data) {
      const container = document.querySelector('.main-content');
      const width = container.clientWidth;
      const height = container.clientHeight - 60;

      transform = d3.zoomIdentity;
      svg.attr('viewBox', [0, 0, width, height]);

      // Scales
      const sizes = data.nodes.map(n => n.size || 10);
      const rScale = d3.scaleSqrt()
        .domain([d3.min(sizes) || 1, d3.max(sizes) || 20])
        .range([5, 20]);

      // Container group
      g = svg.append('g');

      // Links
      const link = g.append('g')
        .selectAll('line')
        .data(data.links)
        .join('line')
        .attr('stroke', '#cbd5e1')
        .attr('stroke-opacity', 0.4)
        .attr('stroke-width', d => Math.sqrt(d.weight || 1) * 1.5);

      // Nodes
      const node = g.append('g')
        .selectAll('g')
        .data(data.nodes)
        .join('g')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      node.append('circle')
        .attr('r', d => rScale(d.size || 10))
        .attr('fill', d => d.color || '#0ea5e9')
        .attr('stroke', 'white')
        .attr('stroke-width', 2)
        .style('cursor', 'pointer');

      // Labels
      const labels = node.append('text')
        .text(d => d.label || d.id)
        .attr('x', d => rScale(d.size || 10) + 5)
        .attr('y', 4)
        .attr('font-size', 11)
        .attr('fill', '#1e293b')
        .attr('opacity', 0)
        .style('pointer-events', 'none');

      // Zoom behavior
      zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on('zoom', (event) => {
          transform = event.transform;
          g.attr('transform', transform);
          
          // Show labels on zoom
          const k = event.transform.k;
          labels.attr('opacity', k > 2 ? 1 : 0);
        });

      svg.call(zoom);

      // Tooltips
      node
        .on('mouseenter', (event, d) => {
          tooltip
            .style('opacity', 1)
            .html(d.title || `<strong>${d.label || d.id}</strong>`);
        })
        .on('mousemove', (event) => {
          tooltip
            .style('left', `${event.pageX}px`)
            .style('top', `${event.pageY}px`);
        })
        .on('mouseleave', () => {
          tooltip.style('opacity', 0);
        });

      // Simulation
      simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(80).strength(0.5))
        .force('charge', d3.forceManyBody().strength(-100))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => rScale(d.size || 10) + 5));

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      // Controls
      document.getElementById('resetBtn').onclick = () => {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
      };

      document.getElementById('centerBtn').onclick = () => {
        simulation.alpha(1).restart();
      };

      let paused = false;
      document.getElementById('pauseBtn').onclick = function() {
        paused = !paused;
        if (paused) {
          simulation.stop();
          this.textContent = 'Resume Simulation';
        } else {
          simulation.restart();
          this.textContent = 'Pause Simulation';
        }
      };

      // Drag functions
      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }

      // Responsive ‚Äì prevent multiple listeners when changing years
      if (resizeHandler) {
        window.removeEventListener('resize', resizeHandler);
      }

      let resizeTimeout;
      resizeHandler = () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const w = container.clientWidth;
          const h = container.clientHeight - 60;
          svg.attr('viewBox', [0, 0, w, h]);
          simulation.force('center', d3.forceCenter(w / 2, h / 2));
          simulation.alpha(0.3).restart();
        }, 250);
      };

      window.addEventListener('resize', resizeHandler);
    }
  </script>
</body>
</html>
