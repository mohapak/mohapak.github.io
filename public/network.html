<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Board Network Analysis - Final</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/graphology@0.25.1"></script>
  <script src="https://unpkg.com/graphology-metrics@2.0.0"></script>
  <style>
    /* --- 1. CORE RESET & VARIABLES --- */
    :root {
      --bg-dark: #0f172a;
      --bg-card: rgba(30, 41, 59, 0.7);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      --border: rgba(148, 163, 184, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 100%);
      color: var(--text-primary);
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* App-like feel */
      display: flex;
      flex-direction: column;
    }

    /* --- 2. HEADER --- */
    .header {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      z-index: 50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.02em; color: #fff; }
    .header p { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }

    /* --- 3. MAIN LAYOUT (DESKTOP) --- */
    .container {
      flex: 1;
      display: flex;
      padding: 1rem;
      gap: 1rem;
      overflow: hidden;
      position: relative;
    }

    /* VISUALIZATION PANEL */
    .viz-panel {
      flex: 1;
      background: radial-gradient(circle at top left, #f8fafc 0, #cbd5e1 100%); /* Light bg for contrast */
      border-radius: 16px;
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* CONTROLS BAR */
    .controls-bar {
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      z-index: 10;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .control-item label { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
    
    select, input {
      border: none; background: transparent; outline: none;
      font-size: 0.85rem; font-weight: 600; color: #334155; width: auto;
    }
    input::placeholder { color: #94a3b8; font-weight: 400; }

    /* ACTION BUTTONS */
    .btn-group { display: flex; gap: 0.5rem; margin-left: auto; }
    button {
      padding: 0.4rem 0.8rem;
      border: none; border-radius: 6px;
      background: var(--bg-dark); color: #fff;
      font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
      cursor: pointer; transition: all 0.2s;
    }
    button.primary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    button:active { transform: scale(0.96); }

    /* SVG AREA */
    #network { width: 100%; flex: 1; cursor: grab; touch-action: none; }
    #network:active { cursor: grabbing; }

    /* SIDEBAR (STATS) */
    .sidebar {
      width: 280px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
      flex-shrink: 0;
    }

    /* STAT CARDS */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.75rem; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05); text-align: center;
    }
    .stat-value { font-size: 1.25rem; font-weight: 700; color: #60a5fa; }
    .stat-label { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; margin-top: 0.25rem; }

    h3 { font-size: 0.8rem; color: #e2e8f0; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
    
    .legend-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 0.4rem; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }

    /* LOADING & OVERLAYS */
    .loading-overlay {
      position: absolute; inset: 0; background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(4px); z-index: 20;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.3s;
    }
    .spinner {
      width: 30px; height: 30px; border: 3px solid #cbd5e1;
      border-top-color: #3b82f6; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .year-watermark {
      position: absolute; bottom: 1rem; right: 1rem;
      font-size: 5rem; font-weight: 900; color: rgba(0,0,0,0.04);
      pointer-events: none; user-select: none; line-height: 1;
    }

    /* TOOLTIP */
    .tooltip {
      position: fixed; opacity: 0;
      background: rgba(15, 23, 42, 0.95);
      color: #fff; padding: 0.75rem 1rem;
      border-radius: 8px; font-size: 0.85rem;
      pointer-events: none; z-index: 1000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      transition: opacity 0.15s;
      max-width: 280px;
    }

    /* --- 4. MOBILE RESPONSIVENESS --- */
    @media (max-width: 768px) {
      body { height: 100%; overflow-y: auto; } /* Allow vertical scroll on body for mobile */
      
      .container {
        flex-direction: column;
        padding: 0.5rem;
        height: auto;
        overflow: visible;
      }

      .header { padding: 0.75rem 1rem; }
      .header h1 { font-size: 0.95rem; }

      /* Graph area gets specific height on mobile */
      .viz-panel {
        height: 60vh; /* Takes 60% of viewport */
        min-height: 350px;
        flex: none;
      }

      .controls-bar {
        padding: 0.5rem;
        gap: 0.5rem;
      }

      .control-item { padding: 0.25rem 0.5rem; flex: 1; justify-content: center; }
      .control-item input { width: 100px; } /* Prevent overflow */
      .btn-group { width: 100%; justify-content: space-between; margin-top: 0.25rem; }
      .btn-group button { flex: 1; }

      /* Sidebar moves to bottom */
      .sidebar {
        width: 100%;
        height: auto;
        overflow: visible;
        background: transparent;
        border: none;
        backdrop-filter: none;
        padding: 0.5rem 0;
      }

      /* Dark cards for mobile stats */
      .stat-grid { grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.5rem; }
      .stat-card { background: rgba(30, 41, 59, 0.6); padding: 0.5rem; }
      .stat-value { font-size: 1rem; }
      .stat-label { font-size: 0.5rem; }

      /* Legend Layout for Mobile */
      .legend-container {
        display: flex; flex-wrap: wrap; gap: 1rem;
        background: rgba(30, 41, 59, 0.6); padding: 1rem; border-radius: 8px;
      }
      .legend-row { margin: 0; }
    }
    
    /* Highlight effect for search */
    .node-highlight { stroke: #f59e0b !important; stroke-width: 4px !important; stroke-opacity: 1; filter: drop-shadow(0 0 4px #f59e0b); }
    .dimmed { opacity: 0.1; transition: opacity 0.3s; }
  </style>
</head>
<body>

  <header class="header">
    <div>
      <h1>Board Network Analysis</h1>
      <p>Tehran Stock Exchange | Thesis Defense</p>
    </div>
  </header>

  <div class="container">
    
    <main class="viz-panel">
      <div class="controls-bar">
        <div class="control-item">
          <label>üìÖ</label>
          <select id="yearSelect">
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024" selected>2024</option>
          </select>
        </div>

        <div class="control-item" style="flex-grow: 2;">
          <label>üîç</label>
          <input type="text" id="searchInput" placeholder="Find firm..." list="firmList">
          <datalist id="firmList"></datalist>
        </div>

        <div class="btn-group">
          <button onclick="resetZoom()">Reset</button>
          <button class="primary" onclick="reCenter()">Center</button>
        </div>
      </div>

      <div class="year-watermark" id="yearBadge">2024</div>
      <svg id="network"></svg>

      <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <div style="font-size:0.8rem; color:#64748b; font-weight:600">Simulating & Calculating Centralities...</div>
      </div>
    </main>

    <aside class="sidebar">
      <div>
        <h3>Network Health</h3>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalNodes">0</div>
            <div class="stat-label">Firms</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalLinks">0</div>
            <div class="stat-label">Links</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgDegree">0</div>
            <div class="stat-label">Avg Deg</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="density">0%</div>
            <div class="stat-label">Density</div>
          </div>
        </div>
      </div>

      <div>
        <h3>Legend</h3>
        <div class="legend-container">
          <div class="legend-row"><div class="dot" style="background:#ef4444"></div> High Centrality (Top 10%)</div>
          <div class="legend-row"><div class="dot" style="background:#10b981"></div> Broker / Bridge</div>
          <div class="legend-row"><div class="dot" style="background:#3b82f6"></div> Standard Firm</div>
        </div>
      </div>

      <div style="font-size: 0.75rem; color: #94a3b8; line-height: 1.5; padding-top: 0.5rem; border-top: 1px solid var(--border);">
        <strong>Instructions:</strong> Drag nodes to rearrange. Scroll/Pinch to zoom. Tap a node to see connection details.
      </div>
    </aside>

  </div>

  <script>
    // --- 1. SETUP ---
    const svg = d3.select("#network");
    const g = svg.append("g");
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");
    
    let width, height, simulation, zoom;
    let currentData = { nodes: [], links: [] };

    // Update Dimensions logic
    function updateDimensions() {
      const container = document.querySelector('.viz-panel');
      width = container.clientWidth;
      height = container.clientHeight - 60; // Subtract control bar height approx 60px
      svg.attr("viewBox", [0, 0, width, height]);
    }
    updateDimensions();

    // Zoom Behavior
    zoom = d3.zoom()
      .scaleExtent([0.1, 10]) 
      .on("zoom", (e) => g.attr("transform", e.transform));
    svg.call(zoom).on("dblclick.zoom", null); 

    // --- 2. DATA LOAD & CENTRALITY CALCULATION ---
    
    // Uses the graphology library loaded via CDN
    function calculateCentralities(data) {
        const Graph = graphology.Graph;
        const metrics = graphology.metrics;
        const graph = new Graph();

        // 1. Add Nodes
        data.nodes.forEach(n => {
            // Ensure ID is a string for graphology
            graph.addNode(String(n.id), { label: n.label, ...n });
        });

        // 2. Add Edges (Network is undirected, weighted by default)
        data.links.forEach(l => {
            // Using try/catch as isolated nodes might cause issues if not removed
            try {
                // Assuming links are symmetric, use undirected. Add weight if present.
                graph.addEdge(String(l.source.id), String(l.target.id), { weight: l.weight || 1 });
            } catch (e) {
                // Edge already exists or node not found
            }
        });

        // 3. Calculate Metrics
        
        // Degree Centrality (simple count of connections)
        const degreeMap = metrics.degree.degree(graph);
        
        // Closeness Centrality (how fast a node can reach all others)
        // Needs to operate on largest connected component for meaningful results if graph is fragmented
        const components = metrics.connectedComponents.connectedComponents(graph);
        const largestComponent = components.reduce((max, c) => c.length > max.length ? c : max, []);
        
        const closenessMap = metrics.closeness.closeness(graph, {
            // Use the largest component to avoid division by zero/NaN for isolated nodes
            nodes: new Set(largestComponent) 
        });
        
        // Betweenness Centrality (how often a node lies on the shortest path between others)
        const betweennessMap = metrics.betweenness.betweenness(graph);

        // Eigenvector Centrality (influence based on connection to high-scoring nodes)
        // This is computationally intensive; we use a simple implementation here.
        let eigenvectorMap = {};
        try {
            eigenvectorMap = metrics.eigenvector.eigenvectorCentrality(graph);
        } catch (e) {
            console.warn("Eigenvector calculation failed (often due to complex component structure):", e.message);
        }


        // 4. Merge results back into the D3 data structure
        const enrichedNodes = data.nodes.map(n => {
            const nodeId = String(n.id);
            return {
                ...n,
                degree: degreeMap[nodeId] || 0,
                closeness: closenessMap[nodeId] || 0,
                betweenness: betweennessMap[nodeId] || 0,
                eigenvector: eigenvectorMap[nodeId] || 0
            };
        });

        return { nodes: enrichedNodes, links: data.links };
    }

    async function loadYear(year) {
      document.getElementById('loader').style.opacity = 1;
      document.getElementById('loader').style.pointerEvents = 'all';
      document.getElementById('yearBadge').innerText = year;

      try {
        const rawData = await d3.json(`data/board_network_${year}_no_isolates.json`);
        
        // --- STEP 1: CALCULATE CENTRALITIES ---
        currentData = calculateCentralities(rawData);
        
        // Populate search
        const list = document.getElementById('firmList');
        list.innerHTML = '';
        currentData.nodes.forEach(n => {
          const op = document.createElement('option');
          op.value = n.label || n.id;
          list.appendChild(op);
        });

        updateStats(currentData);
        render(currentData);
        
      } catch (err) {
        console.error(err);
        alert("Error loading data. Are you running a local server?");
      } finally {
        setTimeout(() => {
          document.getElementById('loader').style.opacity = 0;
          document.getElementById('loader').style.pointerEvents = 'none';
        }, 500);
      }
    }

    // --- 3. RENDER & PHYSICS ---
    function render(data) {
      g.selectAll("*").remove();

      const rScale = d3.scaleSqrt()
        .domain(d3.extent(data.nodes, d => d.size || 1))
        .range([4, 16]);

      // MOBILE OPTIMIZATION: Less aggressive physics on phones
      const isMobile = window.innerWidth < 768;
      const chargeStrength = isMobile ? -200 : -400; 
      const distanceMax = isMobile ? 150 : 300;

      simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(45).strength(0.4))
        .force("charge", d3.forceManyBody().strength(chargeStrength).distanceMax(distanceMax))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("x", d3.forceX(width / 2).strength(0.08)) // Stronger gravity to keep clusters visible
        .force("y", d3.forceY(height / 2).strength(0.08))
        .force("collide", d3.forceCollide().radius(d => rScale(d.size || 1) + 2).iterations(1));

      // Draw Links
      const link = g.append("g")
        .selectAll("line")
        .data(data.links)
        .join("line")
        .attr("stroke", "#94a3b8")
        .attr("stroke-opacity", 0.4)
        .attr("stroke-width", d => Math.sqrt(d.weight || 1));

      // Draw Nodes
      const node = g.append("g")
        .selectAll("circle")
        .data(data.nodes)
        .join("circle")
        .attr("r", d => rScale(d.size || 1))
        .attr("fill", d => d.color || "#3b82f6")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .call(drag(simulation));

      // INTERACTION
      node.on("click", (event, d) => {
        event.stopPropagation();
        showTooltip(event, d, data);
        highlightNeighbors(d, data, node, link);
      });

      // Background click to clear
      svg.on("click", () => {
        tooltip.style("opacity", 0);
        resetHighlight(node, link);
      });

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);
      });
    }

    // --- 4. UX HELPERS ---
    
    function showTooltip(event, d, data) {
      const isMobile = window.innerWidth < 768;
      
      let html = `
        <div style="font-weight:700; color:#60a5fa; margin-bottom:4px; font-size:1rem;">${d.label || d.id}</div>
        <div style="display:grid; grid-template-columns:auto auto; gap:8px; font-size:0.8rem; opacity:0.9;">
          <span>Connections:</span> <span style="font-weight:600; text-align:right">${d.size || 0}</span>
          <span style="grid-column: 1 / span 2; border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0;"></span>
          <span>Degree Centrality:</span> <span style="font-weight:600; text-align:right">${d.degree ? d.degree.toFixed(3) : '0.000'}</span>
          <span>Closeness Centrality:</span> <span style="font-weight:600; text-align:right">${d.closeness ? d.closeness.toFixed(3) : '0.000'}</span>
          <span>Betweenness Centrality:</span> <span style="font-weight:600; text-align:right">${d.betweenness ? d.betweenness.toFixed(3) : '0.000'}</span>
          <span>Eigenvector Centrality:</span> <span style="font-weight:600; text-align:right">${d.eigenvector ? d.eigenvector.toFixed(3) : '0.000'}</span>
        </div>
      `;
      
      tooltip.html(html).style("opacity", 1);

      // SMART POSITIONING
      if (isMobile) {
        tooltip
          .style("top", "60px") // Below header
          .style("left", "50%")
          .style("transform", "translateX(-50%)")
          .style("width", "90%")
          .style("max-width", "400px");
      } else {
        // Desktop: Follow node
        tooltip
          .style("left", (event.pageX + 15) + "px")
          .style("top", (event.pageY - 15) + "px")
          .style("transform", "none")
          .style("width", "auto");
      }
    }

    function highlightNeighbors(d, data, node, link) {
      const neighbors = new Set();
      data.links.forEach(l => {
        if(l.source.id === d.id) neighbors.add(l.target.id);
        if(l.target.id === d.id) neighbors.add(l.source.id);
      });

      node.classed("dimmed", n => n.id !== d.id && !neighbors.has(n.id));
      link.classed("dimmed", l => l.source.id !== d.id && l.target.id !== d.id);
      
      // Make selected node pop
      node.filter(n => n.id === d.id)
          .attr("stroke", "#f59e0b")
          .attr("stroke-width", 3);
    }

    function resetHighlight(node, link) {
      node.classed("dimmed", false).attr("stroke", "#fff").attr("stroke-width", 1.5);
      link.classed("dimmed", false);
    }

    function updateStats(data) {
      document.getElementById('totalNodes').innerText = data.nodes.length;
      document.getElementById('totalLinks').innerText = data.links.length;
      const avg = data.nodes.length ? (data.links.length * 2 / data.nodes.length).toFixed(1) : 0;
      document.getElementById('avgDegree').innerText = avg;
      const pot = (data.nodes.length * (data.nodes.length - 1)) / 2;
      const den = pot ? ((data.links.length / pot) * 100).toFixed(2) : 0;
      document.getElementById('density').innerText = den + "%";
    }

    // --- 5. CONTROLS ---

    function resetZoom() {
      svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
    }

    function reCenter() {
      simulation.alpha(1).restart();
      resetZoom();
    }

    // Drag Logic
    function drag(sim) {
      function start(e) { if(!e.active) sim.alphaTarget(0.3).restart(); e.subject.fx = e.subject.x; e.subject.fy = e.subject.y; }
      function move(e) { e.subject.fx = e.x; e.subject.fy = e.y; }
      function end(e) { if(!e.active) sim.alphaTarget(0); e.subject.fx = null; e.subject.fy = null; }
      return d3.drag().on("start", start).on("drag", move).on("end", end);
    }

    // Search Logic
    document.getElementById('searchInput').addEventListener('change', (e) => {
      const val = e.target.value;
      const target = currentData.nodes.find(n => (n.label || n.id) === val);
      if(target) {
        simulation.alphaTarget(0); 
        const scale = 4;
        svg.transition().duration(1000).call(
          zoom.transform,
          d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-target.x, -target.y)
        );
        
        const nodeSelection = g.selectAll("circle");
        nodeSelection.filter(n => n.id === target.id).classed("node-highlight", true);
        setTimeout(() => nodeSelection.classed("node-highlight", false), 2500);
      }
    });

    document.getElementById('yearSelect').addEventListener('change', (e) => loadYear(e.target.value));

    // Handle Resize
    window.addEventListener('resize', () => {
      updateDimensions();
      if(simulation) {
        simulation.force("center", d3.forceCenter(width / 2, height / 2));
        simulation.alpha(0.3).restart();
      }
    });

    // Init
    loadYear("2024");

  </script>
</body>
</html>
```